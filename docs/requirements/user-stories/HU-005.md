# HU-005: Registrar Ventas y Demanda

---

## Metadata

| Campo | Valor |
|-------|-------|
| **ID** | HU-005 |
| **Prioridad** | Must |
| **RF Relacionados** | RF-024, RF-025, RF-026, RF-027 |
| **Módulo/Componente** | Transacciones - Órdenes de Venta |
| **Estado** | Draft |

---

## Historia de Usuario

**Como** Usuario del sistema,  
**Quiero** registrar las órdenes de venta en firme y efectuadas,  
**Para** que el sistema calcule correctamente la demanda calificada y actualice el inventario.

---

## Criterios de Aceptación

### CA-001: Registrar orden de venta en firme

- **Dado** que un cliente confirma un pedido
- **Cuando** registro la OV, ya sea manualmente, via csv o via API, con fecha, productos y cantidades en estado "En Firme"
- **Entonces** el sistema crea la OV. y solo suma las cantidades a la demanda calificada si el pedido de unidades es mayor al umbral de pico (que es una variable de setup, por defecto 50% de la zona roja)

### CA-002: Marcar OV como efectuada

- **Dado** que existe una OV en firme
- **Cuando** entrego los productos y marco la OV como "Efectuada"
- **Entonces** el sistema genera automáticamente el egreso de inventario y actualiza el stock físico

### CA-003: Cancelar orden de venta en firme

- **Dado** que existe una OV en firme que el cliente cancela
- **Cuando** cancelo la OV indicando el motivo
- **Entonces** el sistema cambia el estado a "Cancelada" y libera las cantidades de la demanda calificada si corresponde

### CA-004: Listar órdenes de venta

- **Dado** que existen múltiples OV registradas
- **Cuando** aplico filtros por estado, rango de fechas o productos
- **Entonces** el sistema muestra solo las OV que cumplen los criterios

### CA-005: Impacto en demanda calificada

- **Dado** que existe una OV en firme por 50 unidades del producto X para entergar hoy
- **Cuando** consulto el flujo neto del producto X
- **Entonces** veo que las 50 unidades están restadas como demanda calificada

---

## Escenarios Alternativos

### Escenario: OV sin stock suficiente

- **Dado** que el producto X tiene 30 unidades en stock
- **Cuando** registro una OV en firme por 50 unidades
- **Entonces** el sistema muestra una advertencia de stock insuficiente pero permite crear la OV

### Escenario: OV parcialmente efectuada

- **Dado** que existe una OV por 100 unidades para entregar hoy
- **Cuando** efectúo solo 80 unidades
- **Entonces** el sistema mantiene 20 unidades en demanda calificada pendiente

---

## Notas y Aclaraciones

- El campo Cliente es opcional para el MVP
- Solo las OV en firme vencidas, o que superen el umbral de pico afectan la demanda calificada
- Las OV efectuadas afectan el inventario físico
- Las OV en firme que no son ni vencidas ni superan el umbral de pico no afectan la demanda calificada, ya que la ecuacion de flujo se actualiza diariamente con la suma de las cantidades de las OV en firme vencidas o que superen el umbral de pico
- El sistema no gestiona facturación ni cobros (fuera del alcance del MVP)

---

## Checklist de Validación

- [x] La historia sigue el formato "Como... Quiero... Para..."
- [x] El valor/beneficio está claramente expresado
- [x] Hay al menos 1 criterio de aceptación
- [x] Los criterios siguen el formato Given/When/Then
- [x] Los RF relacionados están correctamente referenciados
- [x] La prioridad MoSCoW está asignada

---

## Señal de Completación

> Historia de usuario HU-005 completada.
